generator client {
  provider = "prisma-client-js"
  url      = env("DATABASE_URL")
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                     @id @default(cuid())
  email                  String?                    @unique
  emailVerified          DateTime?
  name                   String?                    @unique
  image                  String?
  password               String?
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  role                   String                     @default("user")
  accounts               Account[]
  activities             Activity[]
  argPhaseProgress       ARGPhaseProgress[]
  argPuzzleProgress      ARGPuzzleProgress[]
  receivedMessages       DirectMessage[]            @relation("ReceivedMessages")
  sentMessages           DirectMessage[]            @relation("SentMessages")
  followers              Follow[]                   @relation("Followers")
  following              Follow[]                   @relation("Following")
  forumCommentVotes      ForumCommentVote[]         @relation("ForumCommentVotes")
  forumComments          ForumComment[]             @relation("ForumCommentsAuthor")
  forumPostViews         ForumPostView[]            @relation("ForumPostViews")
  forumPostVotes         ForumPostVote[]            @relation("ForumPostVotes")
  forumPosts             ForumPost[]                @relation("ForumPostsAuthor")
  hintHistory            HintHistory[]              @relation("HintHistoryUser")
  hints                  HintUsage[]
  lobbyMessages          LobbyMessage[]
  notificationPreference NotificationPreference?
  notifications          Notification[]
  puzzleRatings          PuzzleRating[]
  sessionLogs            PuzzleSessionLog[]         @relation("SessionLogUser")
  submissions            PuzzleSubmission[]
  relayMessages          RelayMessage[]
  relayRiddlesDecoder    RelayRiddle[]              @relation("RelayRiddleDecoder")
  relayRiddlesSolver     RelayRiddle[]              @relation("RelayRiddleSolver")
  sessions               Session[]
  teamInvites            TeamInvite[]
  teams                  TeamMember[]
  puzzlePartAssignments  TeamPuzzlePartAssignment[] @relation("PuzzlePartAssignments")
  puzzlePartSubmissions  TeamPuzzlePartSubmission[] @relation("PuzzlePartSubmissions")
  achievements           UserAchievement[]
  escapeRoomProgress     UserEscapeProgress[]
  userPreferences        UserPreferences?
  solvedPuzzles          UserPuzzleProgress[]
  referredBy             UserReferral[]             @relation("Referee")
  referrals              UserReferral[]             @relation("Referrer")
  streak                 UserStreak?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Team {
  id                String                     @id @default(cuid())
  name              String
  description       String?
  createdBy         String
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  isPublic          Boolean                    @default(true)
  joinCode          String?                    @unique @default(cuid())
  invites           TeamInvite[]
  members           TeamMember[]
  progress          TeamProgress[]
  puzzleCompletions TeamPuzzleCompletion[]     @relation("TeamPuzzleCompletions")
  puzzleAssignments TeamPuzzlePartAssignment[] @relation("TeamPuzzleAssignments")
  puzzleSubmissions TeamPuzzlePartSubmission[] @relation("TeamPuzzleSubmissions")

  @@index([createdBy])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     String   @default("member")
  joinedAt DateTime @default(now())
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model TeamInvite {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  invitedBy String
  status    String   @default("pending")
  expiresAt DateTime
  createdAt DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@map("team_invites")
}

model PuzzleCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  color       String?
  icon        String?
  createdAt   DateTime @default(now())
  puzzles     Puzzle[]

  @@map("puzzle_categories")
}

model Puzzle {
  id                       String                     @id @default(cuid())
  title                    String
  description              String?
  content                  String?
  categoryId               String
  order                    Int                        @default(0)
  difficulty               String                     @default("medium")
  requiredPreviousPuzzleId String?
  isActive                 Boolean                    @default(true)
  unlocksAt                DateTime?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  rarity                   String                     @default("common")
  isTeamPuzzle             Boolean                    @default(false)
  minTeamSize              Int                        @default(1)
  puzzleType               String                     @default("general")
  riddleAnswer             String?
  customValidators         CustomValidator[]          @relation("CustomValidators")
  escapeRoom               EscapeRoomPuzzle?
  forumPosts               ForumPost[]
  hintTiers                HintTier[]                 @relation("HintTiers")
  hintUsageLogs            HintUsageLog[]             @relation("HintUsageLogs")
  jigsaw                   JigsawPuzzle?
  leaderboard              LeaderboardEntry[]
  analytics                PuzzleAnalytics?           @relation("PuzzleAnalytics")
  hints                    PuzzleHint[]
  media                    PuzzleMedia[]
  parts                    PuzzlePart[]
  ratings                  PuzzleRating[]
  relationshipsA           PuzzleRelationship[]       @relation("RelationshipA")
  relationshipsB           PuzzleRelationship[]       @relation("RelationshipB")
  schedule                 PuzzleSchedule?            @relation("PuzzleSchedule")
  solutions                PuzzleSolution[]
  submissions              PuzzleSubmission[]
  versions                 PuzzleVersion[]            @relation("PuzzleVersions")
  category                 PuzzleCategory             @relation(fields: [categoryId], references: [id])
  requiredPreviousPuzzle   Puzzle?                    @relation("PuzzleDependency", fields: [requiredPreviousPuzzleId], references: [id])
  nextPuzzles              Puzzle[]                   @relation("PuzzleDependency")
  sudoku                   SudokuPuzzle?
  teamProgress             TeamProgress[]
  completions              TeamPuzzleCompletion[]     @relation("TeamCompletions")
  partAssignments          TeamPuzzlePartAssignment[] @relation("PuzzlePartAssignments")
  partSubmissions          TeamPuzzlePartSubmission[] @relation("PuzzleSubmissions")
  userProgress             UserPuzzleProgress[]

  @@index([categoryId])
  @@index([order])
  @@map("puzzles")
}

model JigsawPuzzle {
  id              String   @id @default(cuid())
  puzzleId        String   @unique
  imageUrl        String?
  gridRows        Int      @default(3)
  gridCols        Int      @default(4)
  snapTolerance   Int      @default(12)
  rotationEnabled Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  puzzle          Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@map("jigsaw_puzzles")
}

model SudokuPuzzle {
  id               String   @id @default(cuid())
  puzzleId         String   @unique
  puzzleGrid       String
  solutionGrid     String
  difficulty       String   @default("medium")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  timeLimitSeconds Int?
  puzzle           Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@map("sudoku_puzzles")
}

model EscapeRoomPuzzle {
  id               String               @id @default(cuid())
  puzzleId         String               @unique
  roomTitle        String
  roomDescription  String
  timeLimitSeconds Int?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  puzzle           Puzzle               @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  stages           EscapeStage[]
  itemDefinitions  ItemDefinition[]
  playerRoomStates PlayerRoomState[]
  layouts          RoomLayout[]
  userProgress     UserEscapeProgress[]

  @@index([puzzleId])
  @@map("escape_room_puzzles")
}

model EscapeStage {
  id                String           @id @default(cuid())
  escapeRoomId      String
  order             Int
  title             String
  description       String
  puzzleType        String
  puzzleData        String
  correctAnswer     String
  hints             String           @default("[]")
  rewardItem        String?
  rewardDescription String?
  createdAt         DateTime         @default(now())
  escapeRoom        EscapeRoomPuzzle @relation(fields: [escapeRoomId], references: [id], onDelete: Cascade)

  @@unique([escapeRoomId, order])
  @@index([escapeRoomId])
  @@map("escape_stages")
}

model UserEscapeProgress {
  id                String           @id @default(cuid())
  userId            String
  escapeRoomId      String
  currentStageIndex Int              @default(0)
  solvedStages      String           @default("[]")
  inventory         String           @default("[]")
  startedAt         DateTime         @default(now())
  completedAt       DateTime?
  totalTimeSpent    Int              @default(0)
  hintsUsed         Int              @default(0)
  escapeRoom        EscapeRoomPuzzle @relation(fields: [escapeRoomId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, escapeRoomId])
  @@index([userId])
  @@index([escapeRoomId])
  @@map("user_escape_progress")
}

model RoomLayout {
  id            String           @id @default(cuid())
  escapeRoomId  String
  title         String?
  backgroundUrl String?
  width         Int?
  height        Int?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  locks         EscapeLock[]
  hotspots      Hotspot[]
  escapeRoom    EscapeRoomPuzzle @relation(fields: [escapeRoomId], references: [id], onDelete: Cascade)
  triggers      RoomTrigger[]

  @@index([escapeRoomId])
  @@map("room_layouts")
}

model Hotspot {
  id        String     @id @default(cuid())
  layoutId  String
  x         Int        @default(0)
  y         Int        @default(0)
  w         Int        @default(32)
  h         Int        @default(32)
  type      String     @default("interactive")
  targetId  String?
  meta      String?
  createdAt DateTime   @default(now())
  layout    RoomLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId])
  @@map("hotspots")
}

model EscapeLock {
  id              String     @id @default(cuid())
  layoutId        String
  lockType        String     @default("code")
  requirement     String?
  secret          String?
  isLocked        Boolean    @default(true)
  requiredItemKey String?
  createdAt       DateTime   @default(now())
  layout          RoomLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId])
  @@map("escape_locks")
}

model ItemDefinition {
  id           String           @id @default(cuid())
  escapeRoomId String
  key          String           @unique
  name         String
  description  String?
  imageUrl     String?
  consumable   Boolean          @default(true)
  createdAt    DateTime         @default(now())
  escapeRoom   EscapeRoomPuzzle @relation(fields: [escapeRoomId], references: [id], onDelete: Cascade)

  @@index([escapeRoomId])
  @@map("item_definitions")
}

model RoomTrigger {
  id        String     @id @default(cuid())
  layoutId  String
  event     String
  action    String
  condition String?
  createdAt DateTime   @default(now())
  layout    RoomLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId])
  @@map("room_triggers")
}

model PlayerRoomState {
  id           String           @id @default(cuid())
  userId       String?
  teamId       String?
  escapeRoomId String
  state        String           @default("{}")
  updatedAt    DateTime         @updatedAt
  createdAt    DateTime         @default(now())
  escapeRoom   EscapeRoomPuzzle @relation(fields: [escapeRoomId], references: [id], onDelete: Cascade)

  @@unique([userId, escapeRoomId])
  @@index([userId])
  @@index([teamId])
  @@index([escapeRoomId])
  @@map("player_room_states")
}

model Asset {
  id         String   @id @default(cuid())
  url        String
  type       String
  fileName   String?
  fileSize   Int?
  mimeType   String?
  uploadedBy String?
  metadata   String?
  createdAt  DateTime @default(now())

  @@map("assets")
}

model PuzzleSolution {
  id               String   @id @default(cuid())
  puzzleId         String
  answer           String
  isCorrect        Boolean  @default(true)
  points           Int      @default(100)
  isRegex          Boolean  @default(false)
  ignoreCase       Boolean  @default(true)
  ignoreWhitespace Boolean  @default(false)
  createdAt        DateTime @default(now())
  puzzle           Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@map("puzzle_solutions")
}

model PuzzleHint {
  id                 String        @id @default(cuid())
  puzzleId           String
  text               String
  order              Int           @default(0)
  costPoints         Int           @default(10)
  maxUsesPerTeam     Int?
  createdAt          DateTime      @default(now())
  averageTimeToSolve Float?
  maxUsesPerUser     Int?
  timesLeadToSolve   Int           @default(0)
  totalUsages        Int           @default(0)
  updatedAt          DateTime      @updatedAt
  history            HintHistory[]
  usages             HintUsage[]
  puzzle             Puzzle        @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@index([order])
  @@map("puzzle_hints")
}

model HintHistory {
  id          String     @id @default(cuid())
  hintId      String
  userId      String
  pointsCost  Int
  revealedAt  DateTime   @default(now())
  solvedAt    DateTime?
  timeToSolve Int?
  leadToSolve Boolean    @default(false)
  wasHelpful  Boolean?
  hint        PuzzleHint @relation(fields: [hintId], references: [id], onDelete: Cascade)
  user        User       @relation("HintHistoryUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([hintId])
  @@index([userId])
  @@index([revealedAt])
  @@map("hint_history")
}

model PuzzleMedia {
  id          String   @id @default(cuid())
  puzzleId    String
  type        String
  url         String
  fileName    String
  fileSize    Int
  mimeType    String
  title       String?
  description String?
  order       Int      @default(0)
  duration    Int?
  width       Int?
  height      Int?
  thumbnail   String?
  uploadedBy  String
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt
  puzzle      Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@index([type])
  @@map("puzzle_media")
}

model HintUsage {
  id     String     @id @default(cuid())
  hintId String
  userId String
  usedAt DateTime   @default(now())
  hint   PuzzleHint @relation(fields: [hintId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([hintId])
  @@index([userId])
  @@map("hint_usages")
}

model UserPuzzleProgress {
  id                    String               @id @default(cuid())
  userId                String
  puzzleId              String
  solved                Boolean              @default(false)
  solvedAt              DateTime?
  attempts              Int                  @default(0)
  pointsEarned          Int                  @default(0)
  viewedAt              DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  averageTimePerAttempt Float?
  completionPercentage  Float                @default(0)
  currentSessionStart   DateTime?
  lastAttemptAt         DateTime?
  successfulAttempts    Int                  @default(0)
  totalTimeSpent        Int                  @default(0)
  partProgress          PuzzlePartProgress[]
  sessionLogs           PuzzleSessionLog[]
  puzzle                Puzzle               @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, puzzleId])
  @@index([userId])
  @@index([puzzleId])
  @@map("user_puzzle_progress")
}

model PuzzleSessionLog {
  id              String             @id @default(cuid())
  progressId      String
  userId          String
  puzzleId        String
  sessionStart    DateTime           @default(now())
  sessionEnd      DateTime?
  durationSeconds Int?
  hintUsed        Boolean            @default(false)
  attemptMade     Boolean            @default(false)
  wasSuccessful   Boolean            @default(false)
  progress        UserPuzzleProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  user            User               @relation("SessionLogUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([progressId])
  @@index([userId])
  @@index([sessionStart])
  @@map("puzzle_session_logs")
}

model PuzzlePart {
  id           String                     @id @default(cuid())
  puzzleId     String
  title        String
  description  String?
  content      String
  order        Int                        @default(0)
  pointsValue  Int                        @default(50)
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  userProgress PuzzlePartProgress[]
  solutions    PuzzlePartSolution[]
  puzzle       Puzzle                     @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  assignments  TeamPuzzlePartAssignment[] @relation("PartAssignments")
  submissions  TeamPuzzlePartSubmission[] @relation("PartSubmissions")

  @@index([puzzleId])
  @@index([order])
  @@map("puzzle_parts")
}

model PuzzlePartSolution {
  id               String     @id @default(cuid())
  partId           String
  answer           String
  isCorrect        Boolean    @default(true)
  points           Int        @default(50)
  isRegex          Boolean    @default(false)
  ignoreCase       Boolean    @default(true)
  ignoreWhitespace Boolean    @default(false)
  createdAt        DateTime   @default(now())
  part             PuzzlePart @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@map("puzzle_part_solutions")
}

model PuzzlePartProgress {
  id           String             @id @default(cuid())
  partId       String
  progressId   String
  solved       Boolean            @default(false)
  solvedAt     DateTime?
  attempts     Int                @default(0)
  pointsEarned Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  part         PuzzlePart         @relation(fields: [partId], references: [id], onDelete: Cascade)
  progress     UserPuzzleProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@unique([partId, progressId])
  @@index([partId])
  @@index([progressId])
  @@map("puzzle_part_progress")
}

model TeamProgress {
  id           String    @id @default(cuid())
  teamId       String
  puzzleId     String
  solved       Boolean   @default(false)
  solvedAt     DateTime?
  solvedBy     String?
  attempts     Int       @default(0)
  pointsEarned Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  puzzle       Puzzle    @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  team         Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, puzzleId])
  @@index([teamId])
  @@index([puzzleId])
  @@map("team_progress")
}

model PuzzleSubmission {
  id          String   @id @default(cuid())
  puzzleId    String
  userId      String
  answer      String
  isCorrect   Boolean
  feedback    String?
  submittedAt DateTime @default(now())
  puzzle      Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@index([userId])
  @@index([isCorrect])
  @@map("puzzle_submissions")
}

model LeaderboardEntry {
  id        String   @id @default(cuid())
  puzzleId  String
  userId    String?
  teamId    String?
  rank      Int
  points    Int
  solvedAt  DateTime
  timeTaken Int?
  createdAt DateTime @default(now())
  puzzle    Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Cascade)

  @@unique([puzzleId, userId, teamId])
  @@index([puzzleId])
  @@index([points])
  @@map("leaderboard_entries")
}

model GlobalLeaderboard {
  id            String   @id @default(cuid())
  userId        String?
  teamId        String?
  totalPoints   Int      @default(0)
  puzzlesSolved Int      @default(0)
  rank          Int?
  updatedAt     DateTime @updatedAt

  @@map("global_leaderboard")
}

model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String
  type        String    @default("info")
  publishedAt DateTime  @default(now())
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  @@index([publishedAt])
  @@map("announcements")
}

model Event {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([startDate, endDate])
  @@map("events")
}

model Achievement {
  id               String            @id @default(cuid())
  name             String            @unique
  title            String
  description      String
  icon             String
  category         String
  rarity           String            @default("common")
  requirement      String
  conditionType    String
  conditionValue   Int?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@map("user_achievements")
}

model UserStreak {
  id              String    @id @default(cuid())
  userId          String    @unique
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastSolveDate   DateTime?
  streakStartDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_streaks")
}

model UserReferral {
  id                         String    @id @default(cuid())
  referrerId                 String
  refereeId                  String?
  inviteCode                 String    @unique @default(cuid())
  inviteEmail                String?
  refereeJoinedAt            DateTime?
  refereeFirstPuzzleSolvedAt DateTime?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  referee                    User?     @relation("Referee", fields: [refereeId], references: [id])
  referrer                   User      @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([refereeId])
  @@index([inviteCode])
  @@map("user_referrals")
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  type        String
  title       String
  message     String
  icon        String?
  relatedId   String?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  emailRead   Boolean   @default(false)
  emailReadAt DateTime?
  emailSent   Boolean   @default(false)
  emailSentAt DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([emailSent])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  emailOnPuzzleRelease      Boolean  @default(true)
  emailOnAchievement        Boolean  @default(true)
  emailOnTeamUpdate         Boolean  @default(true)
  emailOnLeaderboard        Boolean  @default(true)
  emailOnSystem             Boolean  @default(false)
  enableDigest              Boolean  @default(false)
  digestFrequency           String   @default("weekly")
  emailNotificationsEnabled Boolean  @default(true)
  updatedAt                 DateTime @updatedAt
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model UserPreferences {
  id               String   @id @default(cuid())
  userId           String   @unique
  themeBrightness  String   @default("medium")
  fontSize         String   @default("medium")
  spacingMode      String   @default("comfortable")
  reduceAnimations Boolean  @default(false)
  colorContrast    String   @default("normal")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Activity {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  description String
  icon        String?
  relatedId   String?
  relatedType String?
  metadata    String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activities")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model DirectMessage {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String
  content     String
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  recipient   User      @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
  sender      User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
  @@map("direct_messages")
}

model LobbyMessage {
  id        String   @id @default(cuid())
  teamId    String
  puzzleId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([teamId, puzzleId])
  @@index([userId])
  @@map("lobby_messages")
}

model ForumPost {
  id         String          @id @default(cuid())
  title      String
  content    String
  authorId   String
  puzzleId   String?
  viewCount  Int             @default(0)
  replyCount Int             @default(0)
  upvotes    Int             @default(0)
  downvotes  Int             @default(0)
  isPinned   Boolean         @default(false)
  isClosed   Boolean         @default(false)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  comments   ForumComment[]
  views      ForumPostView[]
  userVotes  ForumPostVote[]
  author     User            @relation("ForumPostsAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  puzzle     Puzzle?         @relation(fields: [puzzleId], references: [id])

  @@index([authorId])
  @@index([puzzleId])
  @@index([createdAt])
  @@index([isPinned])
  @@map("forum_posts")
}

model ForumComment {
  id        String             @id @default(cuid())
  content   String
  authorId  String
  postId    String
  replyToId String?
  upvotes   Int                @default(0)
  downvotes Int                @default(0)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  userVotes ForumCommentVote[]
  author    User               @relation("ForumCommentsAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  post      ForumPost          @relation(fields: [postId], references: [id], onDelete: Cascade)
  replyTo   ForumComment?      @relation("CommentReplies", fields: [replyToId], references: [id], onDelete: Cascade)
  replies   ForumComment[]     @relation("CommentReplies")

  @@index([authorId])
  @@index([postId])
  @@index([replyToId])
  @@index([createdAt])
  @@map("forum_comments")
}

model ForumPostVote {
  id        String    @id @default(cuid())
  userId    String
  postId    String
  voteType  String    @default("up")
  createdAt DateTime  @default(now())
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation("ForumPostVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("forum_post_votes")
}

model ForumCommentVote {
  id        String       @id @default(cuid())
  userId    String
  commentId String
  voteType  String       @default("up")
  createdAt DateTime     @default(now())
  comment   ForumComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User         @relation("ForumCommentVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([userId])
  @@index([commentId])
  @@map("forum_comment_votes")
}

model ForumPostView {
  id       String    @id @default(cuid())
  userId   String?
  postId   String
  viewedAt DateTime  @default(now())
  post     ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user     User?     @relation("ForumPostViews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("forum_post_views")
}

model TeamPuzzlePartAssignment {
  id               String     @id @default(cuid())
  teamId           String
  puzzleId         String
  partId           String
  assignedToUserId String
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  assignedToUser   User       @relation("PuzzlePartAssignments", fields: [assignedToUserId], references: [id], onDelete: Cascade)
  part             PuzzlePart @relation("PartAssignments", fields: [partId], references: [id], onDelete: Cascade)
  puzzle           Puzzle     @relation("PuzzlePartAssignments", fields: [puzzleId], references: [id], onDelete: Cascade)
  team             Team       @relation("TeamPuzzleAssignments", fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, puzzleId, partId])
  @@index([teamId])
  @@index([puzzleId])
  @@index([partId])
  @@index([assignedToUserId])
  @@map("team_puzzle_part_assignments")
}

model TeamPuzzlePartSubmission {
  id                String     @id @default(cuid())
  teamId            String
  puzzleId          String
  partId            String
  submittedByUserId String
  answer            String
  isCorrect         Boolean    @default(false)
  attempts          Int        @default(1)
  solvedAt          DateTime?
  createdAt         DateTime   @default(now())
  part              PuzzlePart @relation("PartSubmissions", fields: [partId], references: [id], onDelete: Cascade)
  puzzle            Puzzle     @relation("PuzzleSubmissions", fields: [puzzleId], references: [id], onDelete: Cascade)
  submittedByUser   User       @relation("PuzzlePartSubmissions", fields: [submittedByUserId], references: [id], onDelete: Cascade)
  team              Team       @relation("TeamPuzzleSubmissions", fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([puzzleId])
  @@index([partId])
  @@index([submittedByUserId])
  @@map("team_puzzle_part_submissions")
}

model TeamPuzzleCompletion {
  id                String   @id @default(cuid())
  teamId            String
  puzzleId          String
  totalPointsEarned Int      @default(0)
  completedAt       DateTime @default(now())
  puzzle            Puzzle   @relation("TeamCompletions", fields: [puzzleId], references: [id], onDelete: Cascade)
  team              Team     @relation("TeamPuzzleCompletions", fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, puzzleId])
  @@index([teamId])
  @@index([puzzleId])
  @@map("team_puzzle_completions")
}

model PuzzleRating {
  id        String   @id @default(cuid())
  puzzleId  String
  userId    String
  rating    Int      @db.SmallInt
  review    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  puzzle    Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([puzzleId, userId])
  @@index([puzzleId])
  @@index([userId])
  @@map("puzzle_ratings")
}

model RelayRiddle {
  id                String         @id @default(cuid())
  roomId            String         @unique
  puzzleId          String?
  createdAt         DateTime       @default(now())
  expiresAt         DateTime
  status            String         @default("waiting")
  solverClues       String
  solverAnswer      String
  encryptedMsg      String
  cipherType        String         @default("shift")
  solverUserId      String?
  decoderUserId     String?
  solverSubmittedAt DateTime?
  solvedAt          DateTime?
  messages          RelayMessage[]
  decoder           User?          @relation("RelayRiddleDecoder", fields: [decoderUserId], references: [id])
  solver            User?          @relation("RelayRiddleSolver", fields: [solverUserId], references: [id])

  @@index([roomId])
  @@index([status])
  @@map("relay_riddles")
}

model RelayMessage {
  id        String      @id @default(cuid())
  relayId   String
  userId    String?
  message   String
  createdAt DateTime    @default(now())
  relay     RelayRiddle @relation(fields: [relayId], references: [id], onDelete: Cascade)
  user      User?       @relation(fields: [userId], references: [id])

  @@index([relayId])
  @@index([userId])
  @@map("relay_messages")
}

model ARGPhase {
  id          String             @id @default(cuid())
  name        String
  description String?
  orderIndex  Int
  isActive    Boolean            @default(false)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  progress    ARGPhaseProgress[]
  puzzles     ARGPuzzle[]

  @@index([isActive])
  @@map("arg_phases")
}

model ARGPuzzle {
  id          String              @id @default(cuid())
  phaseId     String
  title       String
  description String?
  puzzleType  String
  difficulty  String
  orderIndex  Int
  puzzleData  Json
  solution    String
  hints       Json
  isPublished Boolean             @default(false)
  createdBy   String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  progress    ARGPuzzleProgress[]
  phase       ARGPhase            @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@index([puzzleType])
  @@index([isPublished])
  @@map("arg_puzzles")
}

model ARGPuzzleProgress {
  id          String    @id @default(cuid())
  userId      String
  puzzleId    String
  completed   Boolean   @default(false)
  attempts    Int       @default(0)
  hintsUsed   Int       @default(0)
  solution    String?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  puzzle      ARGPuzzle @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, puzzleId])
  @@index([userId])
  @@index([puzzleId])
  @@index([completed])
  @@map("arg_puzzle_progress")
}

model ARGPhaseProgress {
  id          String    @id @default(cuid())
  userId      String
  phaseId     String
  completed   Boolean   @default(false)
  completedAt DateTime?
  startedAt   DateTime  @default(now())
  phase       ARGPhase  @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, phaseId])
  @@index([userId])
  @@index([phaseId])
  @@index([completed])
  @@map("arg_phase_progress")
}

model PuzzleTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  puzzleType  String
  content     Json
  tags        Json
  difficulty  String
  category    String?
  isPublic    Boolean  @default(true)
  usageCount  Int      @default(0)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([puzzleType])
  @@index([isPublic])
  @@map("puzzle_templates")
}

model PuzzleVersion {
  id            String    @id @default(cuid())
  puzzleId      String
  versionNumber Int
  status        String    @default("draft")
  title         String
  description   String?
  content       Json
  solutions     Json
  createdAt     DateTime  @default(now())
  createdBy     String
  publishedAt   DateTime?
  notes         String?
  puzzle        Puzzle    @relation("PuzzleVersions", fields: [puzzleId], references: [id], onDelete: Cascade)

  @@unique([puzzleId, versionNumber])
  @@index([puzzleId])
  @@index([status])
  @@map("puzzle_versions")
}

model PuzzleSchedule {
  id                String    @id @default(cuid())
  puzzleId          String    @unique
  releaseAt         DateTime?
  unlocksAt         DateTime?
  timedDuration     Int?
  countdownStartsAt DateTime?
  expiresAt         DateTime?
  timezone          String?
  schedulingType    String    @default("immediate")
  isLive            Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  puzzle            Puzzle    @relation("PuzzleSchedule", fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@index([releaseAt])
  @@map("puzzle_schedules")
}

model HintTier {
  id               String   @id @default(cuid())
  puzzleId         String
  tierNumber       Int
  title            String?
  content          String
  costPoints       Int      @default(0)
  progressRequired Int?
  delaySeconds     Int?
  maxUsesPerPlayer Int      @default(1)
  revealType       String   @default("full")
  isProgressive    Boolean  @default(false)
  createdAt        DateTime @default(now())
  puzzle           Puzzle   @relation("HintTiers", fields: [puzzleId], references: [id], onDelete: Cascade)

  @@unique([puzzleId, tierNumber])
  @@index([puzzleId])
  @@map("hint_tiers")
}

model HintUsageLog {
  id          String   @id @default(cuid())
  puzzleId    String
  userId      String
  hintTierId  String
  usedAt      DateTime @default(now())
  costPaid    Int
  leadToSolve Boolean  @default(false)
  puzzle      Puzzle   @relation("HintUsageLogs", fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@index([userId])
  @@map("hint_usage_logs")
}

model PuzzleAnalytics {
  id                  String   @id @default(cuid())
  puzzleId            String   @unique
  totalAttempts       Int      @default(0)
  totalCompletions    Int      @default(0)
  totalPlayers        Int      @default(0)
  averageSolveTime    Float?
  medianSolveTime     Float?
  tooEasy             Int      @default(0)
  perfectDifficulty   Int      @default(0)
  tooDifficult        Int      @default(0)
  averageHintsUsed    Float?
  abandonmentRate     Float?
  playersWhoUsedHints Int      @default(0)
  dailyAttempts       Json?
  hourlyEngagement    Json?
  lastUpdated         DateTime @default(now()) @updatedAt
  puzzle              Puzzle   @relation("PuzzleAnalytics", fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@map("puzzle_analytics")
}

model CustomValidator {
  id             String   @id @default(cuid())
  puzzleId       String
  validationType String
  name           String?
  pattern        String?
  flags          String?
  scriptCode     String?
  apiEndpoint    String?
  apiMethod      String?  @default("POST")
  apiHeaders     Json?
  priority       Int      @default(1)
  isRequired     Boolean  @default(true)
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  puzzle         Puzzle   @relation("CustomValidators", fields: [puzzleId], references: [id], onDelete: Cascade)

  @@index([puzzleId])
  @@map("custom_validators")
}

model PuzzleRelationship {
  id               String   @id @default(cuid())
  puzzleIdA        String
  puzzleIdB        String
  relationshipType String
  description      String?
  campaignId       String?
  sequenceOrder    Int?
  isRequired       Boolean  @default(false)
  unlocksOn        String?
  createdAt        DateTime @default(now())
  puzzleA          Puzzle   @relation("RelationshipA", fields: [puzzleIdA], references: [id], onDelete: Cascade)
  puzzleB          Puzzle   @relation("RelationshipB", fields: [puzzleIdB], references: [id], onDelete: Cascade)

  @@unique([puzzleIdA, puzzleIdB])
  @@index([puzzleIdA])
  @@index([puzzleIdB])
  @@index([relationshipType])
  @@map("puzzle_relationships")
}

model PuzzleCampaign {
  id                String   @id @default(cuid())
  name              String
  description       String?
  theme             String?
  targetDifficulty  String?
  estimatedPlaytime Int?
  isLinear          Boolean  @default(true)
  maxConcurrent     Int?
  totalReward       Int      @default(0)
  badge             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isLinear])
  @@map("puzzle_campaigns")
}

model BulkOperation {
  id             String    @id @default(cuid())
  operationType  String
  status         String    @default("pending")
  sourceData     Json
  results        Json?
  createdBy      String
  createdAt      DateTime  @default(now())
  completedAt    DateTime?
  errorMessage   String?
  itemsProcessed Int       @default(0)
  itemsTotal     Int       @default(0)

  @@index([status])
  @@index([operationType])
  @@map("bulk_operations")
}
